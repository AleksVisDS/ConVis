var hm;var hc;var persistentExponent=1;function Heatmap(a){this.maindiv=a;this.size=0;this.canvas=a.append("svg").attr("id","heatmap");this.blockG=this.canvas.append("g").attr("id","heatmapblockgroup");this.highlightlines=this.canvas.append("g").attr("id","highlightlines");this.blockSize=function(){return this.size/matrix.dimension};this.blocks=this.blockG.selectAll("rect").data(matrix.data).enter().append("rect");this.generateHeatmapColorScale=function(){var b=[d3.scalePow().exponent(persistentExponent),d3.scalePow().exponent(persistentExponent),d3.scalePow().exponent(persistentExponent)];return{r:b[0].domain([0,matrix.maxVal]).rangeRound([0,heatmapColor[0]]),g:b[1].domain([0,matrix.maxVal]).rangeRound([0,heatmapColor[1]]),b:b[2].domain([0,matrix.maxVal]).rangeRound([0,heatmapColor[2]])}};this.colorScale=this.generateHeatmapColorScale();this.updateBlocks=function(){this.blocks.data(matrix.data).attr("x",function(c,b){return(b%matrix.dimension)*hm.blockSize()}).attr("y",function(c,b){return Math.floor(b/matrix.dimension)*hm.blockSize()}).attr("height",this.blockSize()).attr("width",this.blockSize()).style("fill",function(b){return"rgb("+hm.colorScale.r(b)+","+hm.colorScale.g(b)+","+hm.colorScale.b(b)+")"})}}function HeatmapControl(a){this.maindiv=a.style("overflow-x","auto");this.slider=this.maindiv.style("text-align","center").append("input").style("width",hm.size*0.8+"px").attr("type","range").attr("min","1").attr("max","19").attr("value",function(){var b=persistentExponent;if(b<1){b=b*10}else{b+=9}return b}).on("input",function(){var c=this.value;var b=1;if(c<10){b=c/10}if(c>10){b=c-9}setHeatmapColorScaleExponent(b);updateHeatmap()});this.infotable=this.maindiv.append("table").style("width",hm.size+"px").attr("id","overviewtable");this.update=function(){this.infotable.selectAll("*").remove();addOverviewMenu(this.infotable);addDataBalanceMenu(this.infotable);hc.slider.style("width",hm.size*0.8+"px");hc.infotable.style("width",hm.size+"px")}}function drawHeatmap(b,a){b.style("background-color","black");hm=new Heatmap(b);hc=new HeatmapControl(a);updateHeatmap();return hm}function updateHeatmap(b,d){if(d){var c=hm.maindiv;var a=hc.maindiv;removeHeatmap();drawHeatmap(c,a)}heatmapColorScale=hm.generateHeatmapColorScale();if(b!=null){hm.size=b;hm.canvas.attr("width",b+"px").attr("height",b+"px");hc.update()}hm.updateBlocks()}function removeHeatmap(){hm.maindiv.selectAll("*").remove();hc.maindiv.selectAll("*").remove()}function setRowAndColHighlight(a,b,c){if(a){hm.highlightlines.append("rect").attr("x",c*(hm.size/matrix.dimension)).attr("y",0).attr("width",(hm.size/matrix.dimension)).attr("height",hm.size).style("fill","none").style("stroke-width","1px").style("stroke",colorPredicted);hm.highlightlines.append("rect").attr("x",0).attr("y",b*(hm.size/matrix.dimension)).attr("width",hm.size).attr("height",(hm.size/matrix.dimension)).style("fill","none").style("stroke-width","1px").style("stroke",colorActual)}else{hm.highlightlines.selectAll("rect").remove()}}function setHeatmapColorScaleExponent(a){persistentExponent=a;hm.colorScale=hm.generateHeatmapColorScale()}function addOverviewMenu(a){addDataRow(a,"File",matrix.name);addDataRow(a,"Size",matrix.dimension+"x"+matrix.dimension);addDataRow(a,"Overall accuracy",toPercent(matrix.diagonalSum/matrix.totalSum)+"%","totalaccuracy");addDataRow(a,"Samples",formatOutputNumber(matrix.totalSum),"totalobservations");addDataRow(a,"Extrapolation level",toPercent(matrix.extrapolationLevel)+"%","extrapolationlevel")}function addDataBalanceMenu(b){addDataRow(b,"Samples/class AVG",formatOutputNumber(matrix.classMeanObservations),"classaverage");addDataRow(b,"Samples/class VAR",formatOutputNumber(matrix.classVariance),"classvariance");var a=toPercent(matrix.classMeanDeviation/matrix.classMeanObservations)+"%";addDataRow(b,"Samples/class MD",formatOutputNumber(matrix.classMeanDeviation)+" ("+a+")","classmd");if(matrix.classMeanDeviation/matrix.classMeanObservations<=0.01){addInfoRow(b,"Note: Data is well balanced","rgb(150,255,150)")}else{addInfoRow(b,"Warning: Data is imbalanced","rgb(255,150,150)");if(!matrix.extrapolated){showExtrapolateButton(b,true)}}showTransposeButton(b,true)}function addDataRow(c,b,e,a){var d=c.append("tr");var f=d.append("td").text(b);if(a!=null){addHelpButton(f,a)}d.append("td").text(e)}function addInfoRow(b,d,a){var c=b.append("tr");c.append("td").attr("colspan",3).style("font-weight","bold").style("color",a).text(d)}function showExtrapolateButton(b,d){if(d){var a=b.append("tr").attr("id","extrapolatebutton");var c=a.append("td").text("Extrapolate data");addHelpButton(c,"extrapolation");a.append("td").append("span").attr("class","button").text("Apply").on("click",function(){showExtrapolateButton(b,false);extrapolateMatrix();if(isRangeFilterOn()){updateDashboard(true)}else{updateDashboard()}})}else{b.select("#extrapolatebutton").remove()}}function showTransposeButton(b,d){if(d){var a=b.append("tr").attr("id","transposebutton");var c=a.append("td").text("Transpose matrix");addHelpButton(c,"transpose");a.append("td").append("span").text("Apply").attr("class","button").on("click",function(){transposeMatrix();if(isRangeFilterOn()){updateDashboard(true)}else{updateDashboard()}})}else{b.select("#extrapolatebutton").remove()}};