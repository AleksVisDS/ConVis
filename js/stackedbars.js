var sbp;var sbc;function StackedBarsPanel(a){this.maindiv=a;this.topBarHeight=50;this.topBarMargin=1;this.textHeight=12;this.lineHeight=18;this.scrollBarMargin=20;this.labelsWidth=100;this.defaultBarOpacity=0.8;this.highlightBarOpacity=1;this.width=0;this.contentHeight=function(){return parseInt(a.style("height").replace("px",""))-this.topBarHeight};this.topbar=a.append("div").attr("id","stackedbarscontrol");this.content=a.append("svg").style("display","block").style("position","absolute").style("top",this.topBarHeight+this.topBarMargin+"px").attr("id","stackedbarscontent");this.lines=this.content.selectAll("g").data(classData).enter().append("g");this.labels=this.lines.append("text").attr("font-size",this.textHeight+"px").attr("y",this.textHeight+"px").attr("fill","white");this.leftBarsGroup=this.lines.append("g").attr("transform","translate("+this.labelsWidth+",0)");this.rightBarsGroup=this.lines.append("g").attr("transform","translate("+this.labelsWidth+",0)");this.leftBarsMeasures=["tp","fp","fn"];this.rightBarsMeasures=["precision","recall"];this.leftBars=[];this.rightBars=[];this.leftBars.push(this.leftBarsGroup.append("rect").attr("class","tp bar"));this.leftBars.push(this.leftBarsGroup.append("rect").attr("class","fp bar"));this.leftBars.push(this.leftBarsGroup.append("rect").attr("class","fn bar"));this.rightBars.push(this.rightBarsGroup.append("rect").attr("class","precision bar"));this.rightBars.push(this.rightBarsGroup.append("rect").attr("class","recall bar"));this.leftBarsGroupWidth=function(){return 2*(sbp.width-sbp.labelsWidth)/3};this.rightBarsGroupWidth=function(){return(sbp.width-sbp.labelsWidth)/3};this.backgroundStripes=this.lines.append("rect").attr("x",0).attr("y",0);this.update=function(){this.topbar.style("width",this.width+"px").style("height",this.topBarHeight+"px");this.content.style("width",this.width+"px").style("height",matrix.dimension*this.lineHeight+"px");this.backgroundStripes.attr("opacity",function(g,f){if(f%2){return 0.07}return 0.05}).attr("fill","white").attr("pointer-events","none").attr("width",this.width).attr("height",this.lineHeight);this.lines.attr("transform",function(g,f){return"translate(0,"+f*sbp.lineHeight+")"});this.labels.data(classData).text(function(f){return f.name}).attr("x",function(){return sbp.labelsWidth-this.getComputedTextLength()-5});var e=d3.max(oClassData,function(f){return f.rowSum+f.colSum-f.tp});for(var b=0;b<this.leftBars.length;b++){var c=sbp.leftBarsMeasures[b];this.leftBars[b].data(classData).attr("x",function(g){var f=sbp.leftBarsGroupWidth();switch(c){case"tp":f-=(g.tp/e)*sbp.leftBarsGroupWidth();break;case"fp":f-=((g.tp+g.fp())/e)*sbp.leftBarsGroupWidth();break;case"fn":f-=((g.tp+g.fp()+g.fn())/e)*sbp.leftBarsGroupWidth();break;default:break}return f}).attr("width",function(g){var f=0;switch(c){case"tp":return(g.tp/e)*sbp.leftBarsGroupWidth();break;case"fp":return(g.fp()/e)*sbp.leftBarsGroupWidth();break;case"fn":return(g.fn()/e)*sbp.leftBarsGroupWidth();break;default:break}}).attr("height",sbp.lineHeight-1)}var d=2;for(var b=0;b<this.rightBars.length;b++){var c=sbp.rightBarsMeasures[b];this.rightBars[b].data(classData).attr("x",function(f){posx=sbp.leftBarsGroupWidth();switch(c){case"precision":posx+=(f.recall()/d)*sbp.rightBarsGroupWidth();break;case"recall":break;default:break}return posx}).attr("width",function(g){var f=0;switch(c){case"precision":return(g.precision()/d)*sbp.rightBarsGroupWidth();break;case"recall":return(g.recall()/d)*sbp.rightBarsGroupWidth();break;default:break}}).attr("height",sbp.lineHeight-1)}}}function StackedBarsControl(e){this.maindiv=e;this.leftdiv=this.maindiv.append("div").style("width",sbp.labelsWidth+"px").style("height",sbp.topBarHeight+"px");this.textInputHeight=20;this.textInputBorderWidth=1;this.leftdiv.append("input").attr("id","labelinput").style("position","absolute").style("top",sbp.topBarHeight-(this.textInputHeight+2*this.textInputBorderWidth)+"px").style("height",this.textInputHeight+"px").style("width",sbp.labelsWidth-2+"px").attr("type","text").attr("value",function(){return classFilter.name}).on("keyup",function(){if(d3.event.keyCode==13){filterClassData(this.value);sortClassData();updateDashboard(true)}});this.rightdiv=this.maindiv.append("div").style("display","block").style("position","absolute");this.miniBarSvg=this.rightdiv.append("svg").attr("id","minibarsvg");this.leftBarChartGroupWidth=function(){return sbp.leftBarsGroupWidth()/sbp.leftBarsMeasures.length};this.rightBarChartGroupWidth=function(){return sbp.rightBarsGroupWidth()/sbp.rightBarsMeasures.length};this.barChartGroupHeight=sbp.topBarHeight;this.leftBarChartGroup=this.miniBarSvg.append("g").attr("id","leftgroup").selectAll("g").data(sbp.leftBarsMeasures).enter().append("g");this.rightBarChartGroup=this.miniBarSvg.append("g").attr("id","rightgroup").selectAll("g").data(sbp.rightBarsMeasures).enter().append("g");this.leftBarChartGroupBackground=this.leftBarChartGroup.append("rect").attr("class",function(g){return g});this.rightBarChartGroupBackground=this.rightBarChartGroup.append("rect").attr("class",function(g){return g});this.leftBarChartGroupLabel=this.leftBarChartGroup.append("text").attr("class",function(g){return g+" minibarchartlabel"}).text(function(g){return g.toUpperCase()});this.rightBarChartGroupLabel=this.rightBarChartGroup.append("text").attr("class",function(g){return g+" minibarchartlabel"}).text(function(g){return g.charAt(0).toUpperCase()+g.slice(1)});this.sortButtonPadding=10;this.sortButtonMargin=2;this.sortButtonWidth=15;this.sortButtonHeight=15;this.sortButtonsTotalWidth=function(){return this.sortButtonWidth+2*this.sortButtonPadding};var c=(this.sortButtonsTotalWidth()/2)+","+(this.sortButtonPadding)+" "+this.sortButtonPadding+","+(this.sortButtonPadding+this.sortButtonHeight-this.sortButtonMargin)+" "+(this.sortButtonPadding+this.sortButtonWidth)+","+(this.sortButtonPadding+this.sortButtonWidth-this.sortButtonMargin);var d=(this.sortButtonsTotalWidth()/2)+","+(sbp.topBarHeight-this.sortButtonPadding)+" "+this.sortButtonPadding+","+(this.sortButtonPadding+this.sortButtonHeight+this.sortButtonMargin)+" "+(this.sortButtonPadding+this.sortButtonWidth)+","+(this.sortButtonPadding+this.sortButtonWidth+this.sortButtonMargin);this.sortAscendingButtonL=this.leftBarChartGroup.append("polygon").attr("class","sortbutton").attr("points",c).attr("fill","white").on("click",function(g){if(classSorter.sortOrder=="ascending"&&classSorter.sortBy==g){sortClassData("ascending","id")}else{sortClassData("ascending",g)}updateDashboard()});this.sortDescendingButtonL=this.leftBarChartGroup.append("polygon").attr("class","sortbutton").attr("points",d).attr("fill","white").on("click",function(g){if(classSorter.sortOrder=="descending"&&classSorter.sortBy==g){sortClassData("ascending","id")}else{sortClassData("descending",g)}updateDashboard()});this.sortAscendingButtonR=this.rightBarChartGroup.append("polygon").attr("class","sortbutton").attr("points",c).attr("fill","white").on("click",function(g){if(classSorter.sortOrder=="ascending"&&classSorter.sortBy==g){sortClassData("ascending","id")}else{sortClassData("ascending",g)}updateDashboard()});this.sortDescendingButtonR=this.rightBarChartGroup.append("polygon").attr("class","sortbutton").attr("points",d).attr("fill","white").on("click",function(g){if(classSorter.sortOrder=="descending"&&classSorter.sortBy==g){sortClassData("ascending","id")}else{sortClassData("descending",g)}updateDashboard()});this.miniBarGroupPadding=10;this.miniBarNumber=5;this.miniBarPadding=1;this.miniBarGroupWidthL=function(){return this.leftBarChartGroupWidth()-2*this.miniBarPadding-this.sortButtonsTotalWidth()};this.miniBarGroupWidthR=function(){return this.rightBarChartGroupWidth()-2*this.miniBarPadding-this.sortButtonsTotalWidth()};this.miniBarWidthL=function(){return this.miniBarGroupWidthL()/this.miniBarNumber};this.miniBarWidthR=function(){return this.miniBarGroupWidthR()/this.miniBarNumber};this.leftBarChartGroupBars=this.leftBarChartGroup.append("g").attr("class",function(g){return g+" minibar"});this.rightBarChartGroupBars=this.rightBarChartGroup.append("g").attr("class",function(g){return g+" minibar"});var b=this.miniBarNumber;var a=function(g){return getClassGroupDistribution(g,b)};var f=function(g){return d3.max(a(g),function(h){return h.result})};this.tpBars=this.leftBarChartGroup.selectAll(".tp").selectAll("rect").data(a("tp")).enter().append("rect").attr("class","tp bar");this.fpBars=this.leftBarChartGroup.selectAll(".fp").selectAll("rect").data(a("fp")).enter().append("rect").attr("class","fp bar");this.fnBars=this.leftBarChartGroup.selectAll(".fn").selectAll("rect").data(a("fn")).enter().append("rect").attr("class","fn bar");this.precisionBars=this.rightBarChartGroup.selectAll(".precision").selectAll("rect").data(a("precision")).enter().append("rect").attr("class","precision bar");this.recallBars=this.rightBarChartGroup.selectAll(".recall").selectAll("rect").data(a("recall")).enter().append("rect").attr("class","recall bar");this.leftMiniBars=[this.tpBars,this.fpBars,this.fnBars];this.rightMiniBars=[this.precisionBars,this.recallBars];this.update=function(){this.rightdiv.style("left",sbp.labelsWidth+"px").style("top",0+"px").style("width",(sbp.width-sbp.labelsWidth)+"px").style("height",this.barChartGroupHeight+"px");this.miniBarSvg.style("width",(sbp.width-sbp.labelsWidth)+"px").style("height",this.barChartGroupHeight+"px");this.leftBarChartGroupBackground.attr("x",0).attr("y",0).attr("width",this.leftBarChartGroupWidth()+"px").attr("height",this.barChartGroupHeight+"px").attr("opacity","0.2");this.rightBarChartGroupBackground.attr("x",0).attr("y",0).attr("width",this.rightBarChartGroupWidth()+"px").attr("height",this.barChartGroupHeight+"px").attr("opacity","0.2");this.leftBarChartGroupLabel.attr("x",function(){return sbc.leftBarChartGroupWidth()/2-this.getComputedTextLength()/2}).attr("y",sbp.textHeight);this.rightBarChartGroupLabel.attr("x",function(){return sbc.rightBarChartGroupWidth()/2-this.getComputedTextLength()/2}).attr("y",sbp.textHeight);this.leftBarChartGroup.attr("transform",function(k,j){return"translate("+(sbp.leftBarsMeasures.length-1-j)*sbc.leftBarChartGroupWidth()+",0)"});this.rightBarChartGroup.attr("transform",function(k,j){return"translate("+(sbp.leftBarsGroupWidth()+(sbp.rightBarsMeasures.length-1-j)*sbc.rightBarChartGroupWidth())+",0)"});this.leftBarChartGroup.selectAll(".minibar").attr("transform",function(k,j){return"translate("+sbc.sortButtonsTotalWidth()+",0)"});this.rightBarChartGroup.selectAll(".minibar").attr("transform",function(k,j){return"translate("+sbc.sortButtonsTotalWidth()+",0)"});for(var g=0;g<sbp.leftBarsMeasures.length;g++){var h=sbp.leftBarsMeasures[g];this.leftMiniBars[g].data(a(h)).style("opacity",function(k,i){if(isFiltered(k.measure,i)){return 0.2}}).transition().attr("x",function(k,i){return i*sbc.miniBarWidthL()+"px"}).attr("y",function(i){return sbp.topBarHeight-((i.result/f(h))*sbp.topBarHeight)+"px"}).attr("width",this.miniBarWidthL()-this.miniBarPadding+"px").attr("height",function(i){return(i.result/f(h))*sbp.topBarHeight+"px"});this.leftMiniBars[g].on("click",function(k,i){if(isFiltered(k.measure,i)){removeFilter(k.measure,i)}else{filterClassData(null,new FilterRange(k.measure,i,sbc.miniBarNumber))}updateDashboard(true)}).on("mousemove",function(k,i){var m=k.borders[0];var l=k.borders[1];if(l==Infinity){l=k.maxVal}highlightBarChartClass(true,k.result+" classes with "+m+" to "+l+" "+k.measure.toUpperCase(),"leftminibars")}).on("mouseleave",function(k,i){highlightBarChartClass(false,"","leftminibars")})}for(var g=0;g<sbp.rightBarsMeasures.length;g++){var h=sbp.rightBarsMeasures[g];this.rightMiniBars[g].data(a(h)).style("opacity",function(k,i){if(isFiltered(k.measure,i)){return 0.2}}).transition().attr("x",function(k,i){return i*sbc.miniBarWidthR()+"px"}).attr("y",function(i){return sbp.topBarHeight-((i.result/f(h))*sbp.topBarHeight)+"px"}).attr("width",this.miniBarWidthR()-this.miniBarPadding+"px").attr("height",function(i){return(i.result/f(h))*sbp.topBarHeight+"px"});this.rightMiniBars[g].on("click",function(k,i){if(isFiltered(k.measure,i)){removeFilter(k.measure,i)}else{filterClassData(null,new FilterRange(k.measure,i,sbc.miniBarNumber))}updateDashboard(true)}).on("mousemove",function(k,i){var m=k.borders[0];var l=k.borders[1];if(l==Infinity){l=k.maxVal}highlightBarChartClass(true,k.result+" classes with "+toPercent(m)+"% to "+toPercent(l)+"% "+k.measure,"rightminibars")}).on("mouseleave",function(k,i){highlightBarChartClass(false,"","rightminibars")})}this.sortAscendingButtonL.style("opacity",function(i){if(classSorter.sortOrder=="ascending"&&classSorter.sortBy==i){return 1}});this.sortDescendingButtonL.style("opacity",function(i){if(classSorter.sortOrder=="descending"&&classSorter.sortBy==i){return 1}});this.sortAscendingButtonR.style("opacity",function(i){if(classSorter.sortOrder=="ascending"&&classSorter.sortBy==i){return 1}});this.sortDescendingButtonR.style("opacity",function(i){if(classSorter.sortOrder=="descending"&&classSorter.sortBy==i){return 1}})}}function drawStackedBarsPanel(a){a.style("overflow-y","auto").style("overflow-x","hidden");sbp=new StackedBarsPanel(a);sbc=new StackedBarsControl(sbp.topbar)}function removeStackedBarsPanel(){sbp.maindiv.selectAll("*").remove();sbp=null;sbc=null}function updateStackedBarsPanel(a,c){if(c){var b=sbp.maindiv;removeStackedBarsPanel();drawStackedBarsPanel(b)}sbp.width=a-sbp.scrollBarMargin;sbp.update();sbc.update();addBarChartMouseOver();linkBarChartToClassDetailBox()}function addBarChartMouseOver(){for(var a=0;a<sbp.leftBarsMeasures.length;a++){var b=function(c){return c.name};switch(sbp.leftBarsMeasures[a]){case"tp":b=function(c){highlightBarChartClass(true,c.tp+" TP for "+c.name)};break;case"fp":b=function(c){highlightBarChartClass(true,c.fp()+" FP for "+c.name)};break;case"fn":b=function(c){highlightBarChartClass(true,c.fn()+" FN for "+c.name)};break;default:break}sbp.leftBars[a].on("mousemove",b);sbp.leftBars[a].on("mouseleave",function(){highlightBarChartClass(false)})}for(var a=0;a<sbp.rightBarsMeasures.length;a++){var b=function(c){return c.name};switch(sbp.rightBarsMeasures[a]){case"precision":b=function(c){highlightBarChartClass(true,toPercent(c.precision())+"% precision for "+c.name)};break;case"recall":b=function(c){highlightBarChartClass(true,toPercent(c.recall())+"% recall for "+c.name)};break;default:break}sbp.rightBars[a].on("mousemove",b);sbp.rightBars[a].on("mouseleave",function(){highlightBarChartClass(false)})}}function highlightBarChartClass(b,d,g){if(g==null){g="barchart"}var a=body.select("#hiddenmouseovercanvas");var e=a.select("rect");var h=a.select("text");var f=5;if(b){a.style("visibility","visible");var c=0;h.text(function(){return d}).each(function(){c=this.getComputedTextLength()});e.attr("x",function(){var i=d3.event.clientX+10;if(i>db.width()/2){i-=c+20}return i-f}).attr("y",function(){return d3.event.clientY-sbp.textHeight/2-f}).attr("width",c+2*f).attr("height",sbp.textHeight+2*f);h.attr("x",function(){var i=d3.event.clientX+10;if(i>db.width()/2){i-=this.getComputedTextLength()+20}c=this.getComputedTextLength();return i}).attr("y",function(){return d3.event.clientY+sbp.textHeight/2})}else{a.style("visibility","hidden")}}function linkBarChartToClassDetailBox(){sbp.lines.data(classData).on("click",function(b,a){updateClassDetailBox(b.id)}).on("mouseenter",function(a){setRowAndColHighlight(true,a.id,a.id);setScatterPlotHighlight(true,a.id)}).on("mouseleave",function(a){setRowAndColHighlight(false,a.id,a.id);setScatterPlotHighlight(false,a.id)});sbp.labels.data(classData).on("click",function(b,a){updateClassDetailBox(b.id)})};