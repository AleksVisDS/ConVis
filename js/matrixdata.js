var matrix={name:"",classNames:[],data:[],dimension:0,n:function(){return this.data.length},rowSums:[],colSums:[],diagonalSum:0,totalSum:0,maxVal:0,minVal:0,meanVal:0,at:function(b,a){return this.data[b*this.dimension+a]},classMeanObservations:0,classVariance:0,classMeanDeviation:0,extrapolationLevel:0,extrapolated:false};function cleanMatrixData(){matrix.name="";matrix.data=[];matrix.dimension=0;matrix.rowSums=[];matrix.colSums=[];matrix.diagonalSum=0;matrix.totalSum=0;matrix.maxVal=0;matrix.minVal=0;matrix.meanVal=0;matrix.classMeanObservations=0;matrix.classVariance=0;matrix.classMeanDeviation=0}var oClassData=[];var classData=[];var classFilter={name:"",ranges:[]};var classSorter={sortOrder:"ascending",sortBy:"id"};function Category(e,a,b,c,d){this.id=e;this.name=a;this.rowSum=b;this.colSum=c;this.tp=d;this.precision=function(){if(this.colSum==0){return 0}return this.tp/this.colSum};this.recall=function(){if(this.rowSum==0){return 0}return this.tp/this.rowSum};this.accuracy=function(){if(this.colSum+this.rowSum==0){return 0}return this.tp/(this.rowSum+this.colSum-this.tp)};this.fp=function(){return this.colSum-this.tp};this.fn=function(){return this.rowSum-this.tp}}function FilterRange(c,a,b){this.measure=c;this.index=a;this.distribution=getClassGroupDistribution(c,b);this.from=this.distribution[a].borders[0];this.to=this.distribution[a].borders[1]}function isFiltered(d,b){var a=false;for(var c=0;c<classFilter.ranges.length;c++){if(classFilter.ranges[c].measure==d&&classFilter.ranges[c].index==b){a=true;break}}return a}function removeFilter(b,a){classFilter.ranges=this.classFilter.ranges.filter(function(c){return(c.measure!=b||c.index!=a)});filterClassData()}function sortClassData(b,c){if(b!=null&&c!=null){classSorter.sortOrder=b;classSorter.sortBy=c}var a=1;if(classSorter.sortOrder=="descending"){a=-1}switch(classSorter.sortBy){case"id":classData.sort(function(d,e){return(d.id-e.id)*a});break;case"precision":classData.sort(function(d,e){if(e.colSum==0&&d.colSum==0){return 0}if(e.colSum==0){return a}if(d.colSum==0){return -a}return(d.precision()-e.precision())*a});break;case"recall":classData.sort(function(d,e){if(e.rowSum==0&&d.rowSum==0){return 0}if(e.rowSum==0){return a}if(d.rowSum==0){return -a}return(d.recall()-e.recall())*a});break;case"accuracy":classData.sort(function(d,e){if(d.rowSum+d.colSum==0&&e.colSum+e.rowSum==0){return 0}if(e.rowSum+e.colSum==0){return a}if(d.rowSum+d.colSum==0){return -a}return(d.accuracy()-e.accuracy())*a});break;case"tp":classData.sort(function(d,e){return(d.tp-e.tp)*a});break;case"fp":classData.sort(function(d,e){return(d.fp()-e.fp())*a});break;case"fn":classData.sort(function(d,e){return(d.fn()-e.fn())*a});break;default:break}}function filterClassData(b,a){analyzeMatrix();if(b!=null){classFilter.name=b}if(a!=null){classFilter.ranges.push(a)}if(classFilter.name!=null&&classFilter.name!=""){classData=classData.filter(function(g){return g.name.toLowerCase().includes(classFilter.name.toLowerCase())})}for(var c=0;c<classFilter.ranges.length;c++){var d=classFilter.ranges[c].measure;var f=classFilter.ranges[c].from;var e=classFilter.ranges[c].to;if(d=="tp"){classData=classData.filter(function(g){return !(g.tp>=f&&g.tp<e)})}else{classData=classData.filter(function(g){return !(g[d]()>=f&&g[d]()<e)})}}sortClassData()}function isRangeFilterOn(){return classFilter.ranges.length!=0}function getClassById(a){return oClassData[a]}function analyzeMatrix(){matrix.maxVal=d3.max(matrix.data);matrix.minVal=d3.min(matrix.data);for(var d=0;d<matrix.dimension;d++){var a=0;var c=0;for(var b=0;b<matrix.dimension;b++){a+=matrix.data[d*matrix.dimension+b];c+=matrix.data[b*matrix.dimension+d]}matrix.colSums.push(c);matrix.rowSums.push(a)}matrix.totalSum=0;matrix.diagonalSum=0;for(var d=0;d<matrix.dimension;d++){matrix.totalSum+=matrix.rowSums[d];matrix.diagonalSum+=matrix.data[d*matrix.dimension+d]}matrix.meanVal=d3.mean(matrix.data);matrix.classMeanObservations=d3.mean(matrix.rowSums);matrix.classVariance=0;for(var d=0;d<matrix.dimension;d++){matrix.classVariance+=(matrix.rowSums[d]-matrix.classMeanObservations)*(matrix.rowSums[d]-matrix.classMeanObservations)}matrix.classVariance/=matrix.dimension;matrix.classMeanDeviation=Math.sqrt(matrix.classVariance);updateClassData()}function updateClassData(){oClassData=[];classData=[];for(var a=0;a<matrix.dimension;a++){oClassData.push(new Category(a,matrix.classNames[a],matrix.rowSums[a],matrix.colSums[a],matrix.at(a,a)));classData.push(new Category(a,matrix.classNames[a],matrix.rowSums[a],matrix.colSums[a],matrix.at(a,a)))}}function extrapolateMatrix(){var b=matrix.data;var f=matrix.dimension;var g=matrix.name;var a=matrix.totalSum;var e=d3.max(matrix.rowSums);var h=classData.length;for(var d=0;d<matrix.dimension;d++){var k=e/matrix.rowSums[d];if(matrix.rowSums[d]==0){k=1}for(var c=0;c<matrix.dimension;c++){b[d*matrix.dimension+c]=Math.round(matrix.at(d,c)*k)}}cleanMatrixData();matrix.data=b;matrix.dimension=f;matrix.name=g;analyzeMatrix();matrix.extrapolationLevel=1-(a/matrix.totalSum);matrix.extrapolated=true;renewSortAndFilter()}function transposeMatrix(){var b=[];var d=matrix.dimension;var e=matrix.name;var f=classData.length;for(var c=0;c<matrix.dimension;c++){for(var a=0;a<matrix.dimension;a++){b[c*matrix.dimension+a]=matrix.at(a,c)}}cleanMatrixData();matrix.data=b;matrix.dimension=d;matrix.name=e;analyzeMatrix();renewSortAndFilter()}function renewSortAndFilter(){var a=classSorter.sortOrder;var b=classSorter.sortBy;filterClassData();sortClassData(a,b)}function getClassGroupDistribution(a,f){var k=[];k[f-1]=0;k.fill(0);var g=[0];g[f-1]=0;g.fill(0);var h;if(a=="tp"||a=="fp"||a=="fn"){switch(a){case"tp":h=d3.max(oClassData,function(i){return i.tp});break;case"fp":h=d3.max(oClassData,function(i){return i.fp()});break;case"fn":h=d3.max(oClassData,function(i){return i.fn()});break;default:break}for(var e=1;e<f;e++){g[e]=Math.floor(e*(h/f))}}else{h=1;for(var e=1;e<f;e++){g[e]=e*(1/f)}}for(var e=0;e<oClassData.length;e++){var c;if(a=="tp"){c=oClassData[e][a]}else{c=oClassData[e][a]()}for(var d=g.length;d>=0;d--){if(c>=g[d]){k[d]++;d=0}}}var b=[];for(var e=0;e<f;e++){if(e!=f-1){b.push({measure:a,result:k[e],borders:[g[e],g[e+1]],maxVal:h})}else{b.push({measure:a,result:k[e],borders:[g[e],Infinity],maxVal:h})}}return b}function swapclassData(e,d){var a;a=matrix.classNames[e];matrix.classNames[e]=matrix.classNames[d];matrix.classNames[d]=a;a=matrix.at(e,e);matrix.data[e*matrix.dimension+e]=matrix.at(d,d);matrix.data[d*matrix.dimension+d]=a;a=matrix.at(e,d);matrix.data[e*matrix.dimension+d]=matrix.at(d,e);matrix.data[d*matrix.dimension+e]=a;for(var c=0;c<matrix.dimension;c++){for(var b=0;b<matrix.dimension;b++){if(c==e&&b!=e&&b!=d){a=matrix.at(c,b);matrix.data[e*matrix.dimension+b]=matrix.at(d,b);matrix.data[d*matrix.dimension+b]=a}else{if(b==e&&c!=e&&c!=d){a=matrix.at(c,b);matrix.data[c*matrix.dimension+e]=matrix.at(c,d);matrix.data[c*matrix.dimension+d]=a}}}}analyzeMatrix()};